# slurm.conf file generated by configurator.html.
# Put this file on all nodes of your cluster.
# See the slurm.conf man page for more information.


ClusterName=<%= @config['ClusterName'] %>
ControlMachine=<%= @config['ControlMachine'] %>
#ControlAddr=
#BackupController=
#BackupAddr=

AuthType=auth/munge
CacheGroups=0
CryptoType=crypto/munge
DisableRootJobs=YES
#EnforcePartLimits=NO

CheckpointType=checkpoint/none
JobCheckpointDir=/var/spool/slurm-llnl/checkpoint

<% if @config['Prolog'] %>Prolog=<%= @configdir + '/' + @config['Prolog'] %><% else %>#Prolog unset <% end %>
<% if @config['Epilog'] %>Epilog=<%= @configdir + '/' + @config['Epilog'] %><% else %>#Epilog unset <% end %>

<% if @config['TaskProlog'] %>TaskProlog=<%= @configdir + '/' + @config['TaskProlog'] %><% else %>#TaskProlog unset <% end %>
<% if @config['TaskEpilog'] %>TaskEpilog=<%= @configdir + '/' + @config['TaskEpilog'] %><% else %>#TaskEpilog unset <% end %>

<% if @config['PrologSlurmctld'] %>PrologSlurmctld=<%= @configdir + '/' + @config['PrologSlurmctld'] %><% else %>#PrologSlurmctld unset <% end %>
<% if @config['EpilogSlurmctld'] %>EpilogSlurmctld=<%= @configdir + '/' + @config['EpilogSlurmctld'] %><% else %>#EpilogSlurmctld unset <% end %>

<% if @config['FirstJobID'] %>FirstJobID=<%= @config['FirstJobID'] %><% else %>#FirstJobID unset <% end %>
#GresTypes=
GroupUpdateForce=600
#GroupUpdateTime=600
#JobFileAppend=0
JobRequeue=0
<% if @config['JobSubmitPlugins'] %>JobSubmitPlugins=<%= @config['JobSubmitPlugins'] %><% else %>#JobSubmitPlugins unset <% end %>
#KillOnBadExit=0
#Licenses=foo*4,bar
#MailProg=/bin/mail
MaxJobCount=15000
#MaxTasksPerNode=128
MpiDefault=openmpi
MpiParams=ports=12000-12999
#PluginDir=
<% if @config['PlugStackConfig'] %>JobSubmitPlugins=<%= @config['PlugStackConfig'] %><% else %>#PlugStackConfig unset <% end %>
#PrivateData=jobs
ProctrackType=proctrack/linuxproc
#PropagatePrioProcess=0
PropagateResourceLimits=NONE
#PropagateResourceLimitsExcept=
ReturnToService=2
#SallocDefaultCommand=

SlurmctldPidFile=<%= @rundir %>/<%= @service %>/slurmctld.pid
SlurmctldPort=6817

# Use "%n" with multiple nodes per host
SlurmdPidFile=<%= @rundir %>/<%= @service %>/slurmd.%n.pid
SlurmdPort=6818
SlurmdSpoolDir=/var/tmp/slurmd

SlurmUser=slurm
#SrunEpilog=
#SrunProlog=
StateSaveLocation=/var/spool/<%= @service %>/state
SwitchType=switch/none
TaskPlugin=task/none
#TaskPluginParam=
#TopologyPlugin=topology/tree
TmpFs=/loc
#TrackWCKey=no
#TreeWidth=
#UnkillableStepProgram=
#UsePAM=0
#
# TIMERS
#BatchStartTimeout=10
#CompleteWait=0
#EpilogMsgTime=2000
#GetEnvTimeout=2
#HealthCheckInterval=0
#HealthCheckProgram=
InactiveLimit=0
KillWait=30
MessageTimeout=45
#ResvOverRun=0
MinJobAge=300
OverTimeLimit=2160

<% if @config['SlurmctldTimeout'] %>SlurmctldTimeout=<%= @config['SlurmctldTimeout'] %><% else %>#SlurmctldTimeout unset<% end %>
<% if @config['SlurmdTimeout'] %>SlurmdTimeout=<%= @config['SlurmdTimeout'] %><% else %>#SlurmdTimeout unset<% end %>
#UnkillableStepTimeout=60
#VSizeFactor=0
Waittime=0
#
# SCHEDULING
#DefMemPerCPU=0
#MaxMemPerCPU=0
#SchedulerRootFilter=1
#SchedulerTimeSlice=30
# FastSchedule=2 for testing purposes only
FastSchedule=0
#
SchedulerType=<%= @config['SchedulerType'] %>
SchedulerParameters=<%= @config['SchedulerParameters'] %>

SelectType=select/cons_res
SelectTypeParameters=CR_Core

<% if @config['PreemptMode'] %>PreemptMode=<%= @config['PreemptMode'] %><% else %>#PreemptMode unset <% end %>
<% if @config['PreemptType'] %>PreemptType=<%= @config['PreemptType'] %><% else %>#PreemptType unset <% end %>

#
# JOB PRIORITY
<% if @config['PriorityType'] %>PriorityType=<%= @config['PriorityType'] %><% else %>#PriorityType unset <% end %>
<% if @config['PriorityDecayHalfLife'] %>PriorityDecayHalfLife=<%= @config['PriorityDecayHalfLife'] %><% else %>#PriorityDecayHalfLife unset <% end %>
<% if @config['PriorityCalcPeriod'] %>PriorityCalcPeriod=<%= @config['PriorityCalcPeriod'] %><% else %>#PriorityCalcPeriod unset <% end %>
<% if @config['PriorityFavorSmall'] %>PriorityFavorSmall=<%= @config['PriorityFavorSmall'] %><% else %>#PriorityFavorSmall unset <% end %>
<% if @config['PriorityMaxAge'] %>PriorityMaxAge=<%= @config['PriorityMaxAge'] %><% else %>#PriorityMaxAge unset <% end %>
<% if @config['PriorityUsageResetPeriod'] %>PriorityUsageResetPeriod=<%= @config['PriorityUsageResetPeriod'] %><% else %>#PriorityUsageResetPeriod unset <% end %>
<% if @config['PriorityWeightAge'] %>PriorityWeightAge=<%= @config['PriorityWeightAge'] %><% else %>#PriorityWeightAge unset <% end %>
<% if @config['PriorityWeightFairshare'] %>PriorityWeightFairshare=<%= @config['PriorityWeightFairshare'] %><% else %>#PriorityWeightFairshare unset <% end %>
<% if @config['PriorityWeightPartition'] %>PriorityWeightPartition=<%= @config['PriorityWeightPartition'] %><% else %>#PriorityWeightPartition unset <% end %>
<% if @config['PriorityWeightJobSize'] %>PriorityWeightJobSize=<%= @config['PriorityWeightJobSize'] %><% else %>#PriorityWeightJobSize unset <% end %>
<% if @config['PriorityWeightQOS'] %>PriorityWeightQOS=<%= @config['PriorityWeightQOS'] %><% else %>#PriorityWeightQOS unset <% end %>
#
# LOGGING AND ACCOUNTING
AccountingStorageEnforce=limits,qos
AccountingStorageHost=<%= @config['ControlMachine'] %>
AccountingStorageType=accounting_storage/slurmdbd

JobAcctGatherFrequency=60
JobAcctGatherType=jobacct_gather/linux

DebugFlags=NO_CONF_HASH
SlurmctldDebug=3
SlurmctldLogFile=<%= @config['SlurmctldLogFile'] %>
SlurmdDebug=3
SlurmdLogFile=<%= @config['SlurmdLogFile'] %>
SlurmSchedLogFile=<%= @config['SlurmdSchedLogFile'] %>
SlurmSchedLogLevel=0
#

#PARTITIONS
<% 
#node_string = ''
@partitions.each do |partition, data|
   if !partition.eql? "id" # skips the required 'id' node in the data bag
    node_string = ''  # clears the string
    data_nodes = data['Nodes'] # grabs the Nodes attribute of the json
    data_nodes.each do |data_node| # loop all the Nodes
      node_string << data_node # append the nodes to a string and append comma at the end 
      node_string << ','
    end
    node_string.chop! if node_string.end_with? ','  # strip the trailing comma
%>
PartitionName=<%= data['PartitionName'] %> Default=<%= data['Default'] %> DefaultTime=<%= data['DefaultTime'] %> MaxTime=<%= data['MaxTime'] %> Nodes=<%= node_string %> PreemptMode=<%= data['PreemptMode'] %> Priority=<%= data['Priority'] %> QOS=<%= data['QOS'] %> State=<%= data['State'] %>
<%
  end
end 
%>

# NODES
<% 
@cluster_nodes.each do |cluster_node, data|
   if !cluster_node.eql? "id"
    feature_string = ''  # clears the string
    feature_nodes = data['Feature'] # grabs the Feature attribute of the json
    feature_nodes.each do |feature_node| # loop all the Features
      feature_string << feature_node # append the features to a string and append comma at the end 
      feature_string << ','
    end
    feature_string.chop! if feature_string.end_with? ','  # strip the trailing comma
%>
NodeName=<%= data['NodeName'] %> Sockets=<%= data['Sockets'] %> CoresPerSocket=<%= data['CoresPerSocket'] %> Weight=<%= data['Weight'] %> Feature=<%= feature_string %>
<%
  end
end 
%>

